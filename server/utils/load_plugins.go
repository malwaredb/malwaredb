package utils

import (
	"io/ioutil"
	"os"
	"path/filepath"
	"plugin"
	"fmt"
)

func LoadPlugins() {
	dir, _ := filepath.Abs(filepath.Dir(os.Args[0]))
	pluginsDir := filepath.Join(dir, "plugins")

	pluginFiles, err := ioutil.ReadDir(pluginsDir)
	if err != nil {
		// No plugins directory? No problem.
		return
	}
	serverContext := GetGlobalContext()

	for _, pluginFile := range pluginFiles {
		plugin, err := plugin.Open(filepath.Join(pluginsDir, pluginFile.Name()))
		if err != nil {
			fmt.Fprintf(os.Stderr, "Found and failed to load plugin %s: %v.\n", pluginFile.Name(), err)
		}
		serverContext.FileTypePlugins = append(serverContext.FileTypePlugins, *plugin)
	}
}