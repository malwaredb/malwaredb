-- Tables

create table filetype (
  id serial primary key,
  name text unique not null,
  description text,
  magic bytea[] unique not null,
  executable boolean
);

create table file (
  id bigserial primary key,
  sha1 text not null,
  sha256 text not null,
  sha512 text unique not null,
  md5 text not null,
  lzjd text not null,
  ssdeep text not null,
  sdhsh text not null,
  tlsh text not null,
  firstUpload timestamptz not null,
  createdDate timestamptz not null,
  fileTypeID integer references filetype(id) not null,
  size integer not null,
  entropy real not null,
  confirmedMalicious boolean
);

create table executable (
  fileid bigint references file(id) not null,
  pehash text,
  importhash text,
  packed boolean,
  sections integer not null,
  sectionNames text[],
  sectionEntropies real[],
  sectionExec boolean[],
  primary key(fileid)
);

create table polyglot (
  fileid bigint references file(id) not null,
  filetypeid int references filetype(id) not null,
  primary key (fileid, filetypeid)
);

create table source (
  id bigserial primary key,
  name text unique not null,
  description text,
  url text,
  firstAcquisition timestamptz not null,
  releasable boolean not null
);

create table filesource (
  fileid bigint references file(id) not null,
  sourceid bigint references source(id) not null,
  filename text[] not null,
  firstSeen timestamptz not null
);

create table label (
  id bigserial primary key,
  name text unique not null
);

create table filelabel (
  fileid bigint references file(id) not null,
  labelid bigint references label(id) not null,
  added timestamptz not null,
  primary key (fileid, labelid)
);

create table sourcelabel (
  sourceid bigint references source(id) not null,
  labelid bigint references label(id) not null,
  added timestamptz not null,
  primary key (sourceid, labelid)
);

create table vtclean (
  fileid bigint references file(id) not null,
  tstamp timestamptz not null,
  primary key(fileid, tstamp)
);

create table vthits (
  fileid bigint references file(id) not null,
  tstamp timestamptz not null,
  hits integer not null,
  vtdetail json[],
  primary key (fileid, tstamp, hits)
);

create table mdbconfig (
  version real not null,
  name text not null
);

create table person (
  id serial primary key,
  email text unique not null,
  firstName text not null,
  lastName text not null,
  organisation text,
  phone text,
  password bytea not null,
  apikey text
);

create table grp (
  id serial primary key,
  name text unique not null,
  description text,
  parent integer references grp(id)
);

create table usergroup (
  pid integer references person(id) not null,
  gid integer references grp(id) not null,
  added timestamptz not null,
  primary key(pid, gid)
);

-- Indicies

-- Default Data
insert into filetype(name, description, magic, executable) values
('PE32', '.EXEs and other Windows executables', '{"\x4d54", "\x5a4d"}', true),
('PDF', 'Adobe Portable Document Format (PDF', '{"\x25504446"}', false),
('RTF', 'Rich Text Format (RTF)', '{"\x7b5c727466"}', false);

insert into person(id, email, firstName, lastName, password) values(0, 'admin@example.com', 'admin', 'user', 'not-a-real-password');
insert into grp(id, name, description) values(0, 'admin', 'Administrative users');
insert into usergroup values(0, 0, now());