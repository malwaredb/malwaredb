package main

import (
	"encoding/json"
	"fmt"
	"github.com/rjzak/MalwareDB/mdbcommon"
	"github.com/rjzak/MalwareDB/server/utils"
	"net/http"
	"runtime"
)

func ServerInfo(writer http.ResponseWriter, request *http.Request, config *utils.ServerConfigFile) {
	var err error
	serverContext := utils.GetGlobalContext()
	serverInfo := mdbcommon.ServerInfo{}
	serverInfo.DBName = config.DbDriver.Driver()
	versionRow := config.DbDriver.QueryRow("SHOW server_version;")
	err = versionRow.Scan(&serverInfo.DBVersion)
	if err != nil {
		writer.Write([]byte("Database error"))
		fmt.Printf("Database error getting version number.\n")
		return
	}

	serverInfo.NumSamples = config.DbDriver.NumFiles()
	serverInfo.Uptime = serverContext.TimeRunning().String()
	serverInfo.GoVersion = runtime.Version()
	serverInfo.OSName = runtime.GOOS
	serverInfo.MDBVersion = mdbcommon.VERSION

	result, err := json.Marshal(serverInfo)
	if err != nil {
		writer.Write([]byte("Error creating JSON API Key response"))
		return
	}
	writer.Write([]byte(result))
}