CREATE TABLE mdbconfig (
    version real NOT NULL,
    name text NOT NULL
);

CREATE TABLE file (
    id bigint NOT NULL,
    sha1 text NOT NULL,
    sha256 text NOT NULL,
    sha512 text NOT NULL UNIQUE,
    md5 text NOT NULL,
    lzjd text NOT NULL,
    ssdeep text NOT NULL,
    sdhsh text NOT NULL,
    tlsh text NOT NULL,
    firstupload timestamp with time zone NOT NULL,
    createddate timestamp with time zone NOT NULL,
    filetypeid integer NOT NULL,
    size integer NOT NULL,
    entropy real NOT NULL,
    confirmedmalicious boolean,
    PRIMARY KEY (id)
);

CREATE TABLE executable (
    fileid bigint NOT NULL REFERENCES file(id),
    pehash text,
    importhash text,
    packed boolean,
    sections integer NOT NULL,
    sectionnames text[],
    sectionentropies real[],
    sectionexec boolean[],
    PRIMARY KEY (fileid)
);

CREATE TABLE pdf (
    fileid bigint NOT NULL REFERENCES file(id),
    pages int,
    streams int,
    javascript int,
    openAction int,
    largeColourSpace boolean,
    embeddedFiles int,
    PRIMARY KEY (fileid)
);

CREATE TABLE label (
    id bigint NOT NULL,
    name text NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE source (
    id bigserial NOT NULL,
    name text NOT NULL,
    description text,
    url text,
    firstacquisition timestamp with time zone NOT NULL,
    releasable boolean NOT NULL,
    PRIMARY KEY (id)
);

CREATE TABLE filelabel (
    fileid bigint NOT NULL REFERENCES file(id),
    labelid bigint NOT NULL REFERENCES label(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, labelid)
);

CREATE TABLE sourcelabel (
    sourceid bigint NOT NULL REFERENCES source(id),
    labelid bigint NOT NULL REFERENCES label(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (sourceid, labelid)
);

CREATE TABLE filesource (
    fileid bigint NOT NULL REFERENCES file(id),
    sourceid bigint NOT NULL REFERENCES source(id),
    filename text[] NOT NULL,
    firstseen timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, sourceid)
);

CREATE TABLE filetype (
    id serial NOT NULL,
    name text NOT NULL UNIQUE,
    description text,
    magic bytea[] NOT NULL UNIQUE,
    executable boolean,
    PRIMARY KEY (id)
);

INSERT INTO filetype(name,description,magic,executable) VALUES
('PE32', '.EXEs and other Windows executables', '{x4d54,x5a4d}', true),
('ELF', 'Executable and Linkable Format, used for applications and libraries on Linux, BSD, Solaris, Haiku, and other OSes', '{x7f454c46}', true),
('PDF', 'Adobe Portable Document Format (PDF)', '{x25504446}', false),
('RTF', 'Rich Text Format (RTF)', '{x7b5c727466}', false);


CREATE TABLE grp (
    id integer NOT NULL,
    name text NOT NULL,
    description text,
    parent integer,
    PRIMARY KEY (id)
);


CREATE TABLE person (
    id serial NOT NULL,
    email text NOT NULL UNIQUE,
    uname text NOT NULL UNIQUE,
    firstname text NOT NULL,
    lastname text NOT NULL,
    organisation text,
    phone text,
    password bytea,
    apikey text UNIQUE,
    created timestamp with time zone NOT NULL DEFAULT current_timestamp,
    PRIMARY KEY (id)
);

INSERT INTO PERSON VALUES(0, 'example.com', 'admin', 'ADMIN', 'USER', NULL, NULL, NULL, NULL, current_timestamp);

CREATE TABLE polyglot (
    fileid bigint NOT NULL REFERENCES file(id),
    filetypeid integer NOT NULL REFERENCES filetype(id),
    explaination text,
    PRIMARY KEY (fileid, filetypeid)
);


CREATE TABLE usergroup (
    pid integer NOT NULL REFERENCES person(id),
    gid integer NOT NULL REFERENCES grp(id),
    added timestamp with time zone NOT NULL,
    PRIMARY KEY (pid, gid)
);


CREATE TABLE vtclean (
    fileid bigint NOT NULL REFERENCES file(id),
    tstamp timestamp with time zone NOT NULL,
    PRIMARY KEY (fileid, tstamp)
);


CREATE TABLE vthits (
    fileid bigint NOT NULL REFERENCES file(id),
    tstamp timestamp with time zone NOT NULL,
    hits integer NOT NULL,
    vtdetail json[],
    PRIMARY KEY (fileid, tstamp)
);


